---
aside: false
layout: doc
title: 位置追踪
---

[文：【位置追踪】注意事项]: # 'https://support.qq.com/products/321980/faqs/102055'

​## 简介

本功能用于在空荧酒馆中同步显示玩家在游戏中的坐标，以方便查找附近的宝箱。本功能基于图像识别实现，不是外挂，不会导致封号，但识别精度有限。

若想使用本功能，请确认：

- 您的操作版本至少是 **win10 或以上版本** (win7 不支持追踪)
- 由于云原神可能加强了DRM保护，有大概率无法抓取到画面，可能无法追踪。
- 使用**官方正版原神客户端**，不限服务器，支持 Unity 客户端。
- 支持非官方启动器，只要游戏本体是官方正版即可。
- 游戏内【解锁神像点亮地图】，游戏内【左上角小地图】完整
- 游戏内【左上角小地图】中，无大面积遮挡 (如黄色的任务范围圆圈)，设置为北向上
- 可支持独占全屏，推荐使用【无边框全屏】模式运行游戏。

## 基础说明

成功开启位置追踪后，菜单左下角会出现位置追踪版本号。

​​![image](https://github.com/Sallee1/docs/assets/99392726/4cdb4060-6aee-4ebf-9475-df58968266ad)

将实时识别游戏内**当前角色位置** (小地图坐标位置) 并同步显示到【地图客户端】上 (像游戏内地图一样)。以便于对照地图，防止迷路。

![image](https://github.com/Sallee1/docs/assets/99392726/e23d5c97-9951-4f37-a33b-f39b4ba01521)

## 窗口黄框说明

在较新的Windows版本中，通过WGC(Windows Graphics Capture)，对应酒馆选项是DirectX，抓屏会强制在被抓取画面外围标记黄框。

由于酒馆客户端是Win32应用，黄框需要宿主应用是UWP应用且声明抓屏权限才能去除，所以目前无法去除。

可以尝试使用bitblt，但目前发现部分系统（尤其是Win11）使用bitblt抓取画面会黑屏，如果不能使用就只能使用DirectX(WGC)。

## 云原神客户端使用说明

之前有一段时间是可以使用的，但目前已无任何已知方法可以稳定抓取到云原神的画面。

目前版本保留了云原神的抓取功能，但不保证能抓取到画面。

切换到bitblt模式，如果在“位置追踪>追踪截图”获取到的追踪截图有画面，那就可以用，否则无解。

## 关于HDR的说明

注意目前原神PC客户端不支持HDR，这里的HDR是指通过第三方软件增强游戏画面对比度

目前Windows的截图功能对HDR内容存在bug，会导致亮度异常升高，包括使用Windows上的AutoHDR，以及通过注册表开启原神官方HDR，解决方法是在设置中将SDR亮度调整到最低

NVIDIA App提供的RTX HDR可以在截图时保留正确的亮度（无论SDR亮度如何），建议使用此方式开启HDR

其他显卡尚未测试，自测时可以在“设置>位置追踪>追踪截图”获取，然后在“设置>位置追踪>截图目录”中查看颜色是否正确

## 扩展使用

- 可在设置中开启【窗口置顶】，并拖动缩小地图窗口，以替代游戏内小地图
- 可在设置中开启【覆盖模式】，可自行设置触发快捷键，以替代游戏内大地图

## 注意事项

### 位置追踪无反应

- 如果位置追踪长时间没反应，或者出现原地卡死，可使用菜单中的“追踪截图”功能获取追踪截图，并选择“截图目录”查看。
- 如果追踪截图空白，或者追踪截图截取的是很久以前的画面，启动器的画面，空荧酒馆的画面，请尝试重启空荧酒馆客户端。如果依然无效，请向开发者反馈。
- 如果能正常截图，但依然出现原地卡死，请检查地图是否是**北向上，分辨率是否过小 (不小于 1280x720，建议 1920x1080 以上)，地图是否解锁，是否有大面积遮挡，是否有显著的特征。**若调整后依旧无法追踪，请参见文末提交反馈。
- 开启了**滤镜**或者**HDR**可能会降低追踪的精度，请权衡画面和追踪的质量适当调整滤镜或者关闭

### 位置追踪坐标错误

- 表现为箭头能跟着角色移动，没有晃动等异常情况，但坐标偏差很大 (比如人在璃月港，箭头却在层岩巨渊)。
- 或者已经更新到新版本，但新地图依然无法追踪
  - 重启地图客户端，在设置中选择“清理定位缓存”后重新开启即可。

### 位置追踪晃动，速度慢

限于纯视觉算法限制，在特定地区下，晃动和延迟很难避免，10m 以内算正常误差

目前以下情况可能产生很大误差：

- 对于形状比较规则的区域 (梅洛彼得堡，赤王遗迹群等) 识别精度可能会大幅度下降。
- 特征不明显的区域 (沙漠，平原，海洋等)，坐标偏移比较严重

以下是减轻晃动的几个建议：

- 如果能正常截图，但时常出现乱晃的现象，请检查**分辨率是否过小 (不小于 1280x720，建议 1920x1080 以上)，小地图是否解锁，是否有大面积遮挡，是否有显著的特征**。
- 若开启**滤镜、HDR** 等改变色彩显示的功能，则可能会影响到位置追踪的精度。
- **后台暂停**会导致位置追踪也同时暂停，可能会导致切地图时，追踪延迟变高。
- 在配置允许的情况下，将追踪间隔调到 0.1秒，能比较好的改善延迟高的问题。

### 位置卡在璃月港或者左上角

这个目前暂时确定是客户端热更新框架带来的新bug，会在没有坐标数据的时候卡在这两个位置，由于测试环境无法复现所以暂时没有解决方法。如果长期卡顿请按照上述“位置追踪无反应”处理。

### 瞬移

为了优化匹配速度，传送后会先做全图但比较粗糙的全局匹配，然后使用精细但范围小的局部匹配验证是否正确。但由于匹配结果不可控，会有较小概率在错误的坐标验证通过。

目前暂时没有解决方法，考虑到误检测到错误位置后，后续局部匹配更容易失败从而重新触发全局匹配，可边让角色行走（让小地图平移从而刷新出新的特征）边等待位置追踪收敛到正确的位置。

当位置追踪收敛后，效果就是箭头会随着角色的移动而流畅变化，而不是卡顿在一个位置不动

如果收敛后位置不正确，参照位置追踪坐标错误处理

另外还有一种瞬移的情况，是在没有小地图的界面上（比如打开大地图，打开背包，过剧情等）位置追踪可能会误识别。这是目前为了能提高位置追踪可用性（包括抗滤镜变化等）带来的副作用，目前暂时没有在不降低可用性的情况下减少无小地图界面误识别的方法。

### 位置追踪崩溃

位置追踪有概率会崩溃，崩溃的表现包括但不限于：

- 弹出“Runtime Error”窗口或者“该内存不能为 Read”
- 地图客户端突然无响应
- 地图客户端自动关闭，任务栏卡派蒙
- 地图客户端所有地图消失，变成灰蓝底暗角

如果遇到以上情况，请检查“空荧酒馆”的安装目录是否生成 dmp 格式的文件。如果有，则证明位置追踪发生了崩溃现象。

遇到崩溃，可以先尝试清理定位缓存，如果无效，可以升级或者重装显卡驱动

如果依旧不行，请添加反馈 QQ 群，并把 dmp 文件发送给@小狸卡分析崩溃原因
如果有其他问题请提交反馈。

紧急问题请加入开发反馈 QQ 群：228382171
